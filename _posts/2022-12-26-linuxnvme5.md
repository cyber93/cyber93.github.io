---
title:  "Admin SQ/CQ 생성"
excerpt: "Linux NVMe Driver 이야기 #5"

toc: true
toc_sticky: true

categories:
  - NVMe Storage Technology
tags:
  - Linux NVMe Driver 이야기
---

<br>

# [Admin SQ/CQ 생성](https://mp.weixin.qq.com/s?__biz=MzIwNTUxNDgwNg==&mid=2247484487&idx=1&sn=86faf2642de8f4ebf12e124541315fc2&chksm=972ef51ea0597c085e4e492dea825f76978c9bd9a7442df2964246b78cee23002ac77fb32c69&scene=21#wechat_redirect)

이전 글에서는 nvme_pci_enable() 함수의 내용을 분석해 보았고, 이번에는 nvme_reset_work() 함수의 다른 기능들을 소개하도록 하겠습니다.

> nvme_reset_work() 함수의 주요 작업은 다음과 같이 요약할 수 있습니다.
>
> 1. nvme_reset_work() 함수를 입력한 후, NVME_CTRL_RESETTING 플래그를 먼저 확인하여 nvme_reset_work() 함수가 반복적으로 호출되지 않도록 합니다.
> 2. nvme_pci_enable() 함수 호출
> 3. **nvme_configure_admin_queue()** 함수 호출
> 4. nvme_init_queue() 함수 호출
> 5. nvme_alloc_admin_tags() 함수 호출
> 6. nvme_init_identify() 함수 호출
> 7. nvme_setup_io_queues() 함수 호출
> 8. nvme_start_queues()/nvme_dev_add() 함수 호출 후 nvme_queue_scan() 함수 호출



## nvme_configure_admin_queue() 함수



```c
static int nvme_configure_admin_queue(struct nvme_dev *dev)
{
	int result;
	u32 aqa;

	//컨트롤러의 CAP 레지스터 내용 가져오기 및 서브시스템 Reset 기능 지원 여부 판단
	u64 cap = lo_hi_readq(dev->bar + NVME_REG_CAP);
	struct nvme_queue *nvmeq;
	dev->subsystem = readl(dev->bar + NVME_REG_VS) >= NVME_VS(1, 1, 0) ?
						NVME_CAP_NSSRC(cap) : 0;

	if (dev->subsystem &&
	    (readl(dev->bar + NVME_REG_CSTS) & NVME_CSTS_NSSRO))
		writel(NVME_CSTS_NSSRO, dev->bar + NVME_REG_CSTS);

	result = nvme_disable_ctrl(&dev->ctrl, cap);
	if (result < 0)
		return result;

	nvmeq = dev->queues[0];
	if (!nvmeq) {
		nvmeq = nvme_alloc_queue(dev, 0, NVME_AQ_DEPTH);
		if (!nvmeq)
			return -ENOMEM;
	}

	aqa = nvmeq->q_depth - 1;
	aqa |= aqa << 16;
	writel(aqa, dev->bar + NVME_REG_AQA);
	lo_hi_writeq(nvmeq->sq_dma_addr, dev->bar + NVME_REG_ASQ);
	lo_hi_writeq(nvmeq->cq_dma_addr, dev->bar + NVME_REG_ACQ);

	result = nvme_enable_ctrl(&dev->ctrl, cap);
	if (result)
		return result;

	nvmeq->cq_vector = 0;
	result = queue_request_irq(nvmeq);
	if (result) {
		nvmeq->cq_vector = -1;
		return result;
	}

	return result;
}
```

